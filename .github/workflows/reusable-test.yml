name: Reusable Test Workflow

on:
  workflow_call:
    inputs:
      os:
        description: 'Operating systems to test on (JSON array)'
        required: false
        type: string
        default: '["ubuntu-latest"]'
      run-pre-commit:
        description: 'Run pre-commit hooks before tests'
        required: false
        type: boolean
        default: true
      run-style-check:
        description: 'Run style checks before tests (ignored if run-pre-commit is true)'
        required: false
        type: boolean
        default: true
      style-command:
        description: 'Style check command (ignored if run-pre-commit is true)'
        required: false
        type: string
        default: 'pixi run style-check'
      test-command:
        description: 'Test command to run'
        required: false
        type: string
        default: 'pixi run test'
      upload-coverage:
        description: 'Upload coverage to Codecov'
        required: false
        type: boolean
        default: true
      use-ssh:
        description: 'Use SSH for private repo access (requires CICD secret)'
        required: false
        type: boolean
        default: false
    secrets:
      CODECOV_TOKEN:
        required: false
      CICD:
        description: 'SSH deploy key for private repo access'
        required: false

jobs:
  test:
    strategy:
      matrix:
        os: ${{ fromJson(inputs.os) }}
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH for private repos
        if: inputs.use-ssh
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.CICD }}

      - name: Configure git for private repos (SSH)
        if: inputs.use-ssh
        run: git config --global url."git@github.com:".insteadOf "https://github.com/"

      - name: Setup pixi
        uses: prefix-dev/setup-pixi@v0.8.12
        with:
          pixi-version: "latest"
          cache: true
          cache-write: ${{ github.event_name == 'push' && github.ref_name == 'main' }}
          locked: false

      - name: Run pre-commit hooks
        if: inputs.run-pre-commit
        uses: pre-commit/action@v3.0.1

      - name: Run style checks (fallback)
        if: ${{ !inputs.run-pre-commit && inputs.run-style-check }}
        run: ${{ inputs.style-command }}

      - name: Run tests
        run: ${{ inputs.test-command }}

      - name: Upload coverage to Codecov
        if: inputs.upload-coverage && matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          fail_ci_if_error: false
